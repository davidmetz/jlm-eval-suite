HLS_TEST_SRC = $(HLS_TEST_ROOT)/src
HLS_TEST_BUILD = $(HLS_TEST_ROOT)/build

NC=\033[0m
RED=\033[0;31m
GREEN=\033[0;32m
BLUE=\033[1;34m

TESTLOG = true

HLS_TEST_FILES = \
	test-return.c \
	test-arithmetic.c \
	test-loop.c \
	test-nested-loops.c \
	test-conditional.c \
	test-load.c \
	test-array.c \
	test-gep.c \
	test-global.c \
	test-matrix.c \
	test-cpu.c \

.PHONY: hls-test
hls-test:
	@mkdir -p $(HLS_TEST_BUILD)
	@cd $(HLS_TEST_BUILD) && \
		set -e ; \
		for TEST in $(HLS_TEST_FILES) ; do \
			printf '$(BLUE)Building: $(NC)%s\n' $$TEST ; \
			$(HLS) $(HLS_TEST_SRC)/$$TEST --circt --hls-function=run -o $(HLS_TEST_BUILD)/$$TEST.out 1> /dev/null ; \
		done ;

.PHONY: hls-test-run
hls-test-run: hls-test
	@rm -rf $(HLS_TEST_ROOT)/hls-test.log
	@cd $(HLS_TEST_BUILD) && \
	for TEST in $(HLS_TEST_FILES) ; do \
		printf '$(BLUE)Running: $(NC)%s\n' $$TEST ; \
		$(TESTLOG) -n "$$TEST: " ; \
		if $(HLS_TEST_BUILD)/$$TEST.out >> $(HLS_TEST_ROOT)/hls-test.log 2>&1 ; then \
			$(TESTLOG) pass ; \
		else \
			$(TESTLOG) FAIL ; FAILED_TESTS="$$FAILED_TESTS $$TEST" ; fi ; \
	done ; \
	set -e ; \
	if [ "x$$FAILED_TESTS" != x ] ; then \
		printf '$(RED)%s$(NC)%s\n' "Failed hls-tests:" "$$FAILED_TESTS" ; exit 1 ; \
	else \
		printf '$(GREEN)%s\n$(NC)' "All hls-tests passed" ; fi ;

#
# Polybench
#

HLS_POLYBENCH_SRC = $(HLS_TEST_ROOT)/src/polybench

HLS_POLYBENCH_FILES = \
	correlation.c \
	jacobi-1d.c \

.PHONY: hls-test-polybench
hls-test-polybench:
	@mkdir -p $(HLS_TEST_BUILD)
	@cd $(HLS_TEST_BUILD) && \
		set -e ; \
		for TEST in $(HLS_POLYBENCH_FILES) ; do \
			printf '$(BLUE)Building: $(NC)%s\n' $$TEST ; \
			$(HLS) $(HLS_POLYBENCH_SRC)/$$TEST \
				$(HLS_POLYBENCH_SRC)/polybench.c \
				-I$(HLS_POLYBENCH_SRC) \
				-D=DATA_TYPE_IS_INT \
				-D=POLYBENCH_DUMP_ARRAYS \
				-D=POLYBENCH_USE_C99_PROTO \
				--circt \
				--hls-function=kernel \
				-o $(HLS_TEST_BUILD)/$$TEST.out \
				1> /dev/null ; \
		done ;

.PHONY: hls-test-polybench-run
hls-test-polybench-run: hls-test-polybench
	@rm -rf $(HLS_TEST_ROOT)/hls-test-polybench.log
	@cd $(HLS_TEST_BUILD) && \
	for TEST in $(HLS_POLYBENCH_FILES) ; do \
		printf '$(BLUE)Running: $(NC)%s\n' $$TEST ; \
		$(TESTLOG) -n "$$TEST: " ; \
		if $(HLS_TEST_BUILD)/$$TEST.out >> $(HLS_TEST_ROOT)/hls-test-polybench.log 2>&1 ; then \
			$(TESTLOG) pass ; \
		else \
			$(TESTLOG) FAIL ; FAILED_TESTS="$$FAILED_TESTS $$TEST" ; fi ; \
	done ; \
	set -e ; \
	if [ "x$$FAILED_TESTS" != x ] ; then \
		printf '$(RED)%s$(NC)%s\n' "Failed hls-tests:" "$$FAILED_TESTS" ; exit 1 ; \
	else \
		printf '$(GREEN)%s\n\$(NC)' "All hls-tests passed" ; fi ;


.PHONY: hls-test-clean
hls-test-clean:
	rm -rf $(HLS_TEST_BUILD)
